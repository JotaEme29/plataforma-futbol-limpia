rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function - Verificar si el usuario es administrador del club
    function isAdmin(clubId) {
      let userData = exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) 
        ? get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data 
        : null;
      return request.auth != null && 
             userData != null &&
             userData.rol == 'administrador_club' &&
             userData.clubId == clubId;
    }
    
    // Helper function - Verificar si el usuario es miembro del club
    function isClubMember(clubId) {
      let userData = exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) 
        ? get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data 
        : null;
      return request.auth != null && 
             userData != null &&
             userData.clubId == clubId;
    }
    
    // Helper function - Verificar si el usuario es entrenador de un equipo específico
    function isTeamCoach(clubId, equipoId) {
      let userData = get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
      return request.auth != null && 
             userData.clubId == clubId &&
             userData.rol == 'entrenador' &&
             userData.equipoId == equipoId;
    }
    
    // Helper function - Verificar si el usuario puede gestionar un equipo (admin o entrenador asignado)
    function canManageTeam(clubId, equipoId) {
      let userData = get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
      return request.auth != null && 
             userData.clubId == clubId &&
             (userData.rol == 'administrador_club' || 
              (userData.rol == 'entrenador' && userData.equipoId == equipoId));
    }
    
    // Helper function - Verificar si el usuario pertenece a un equipo específico
    function belongsToTeam(clubId, equipoId) {
      let userData = get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
      return request.auth != null && 
             userData.clubId == clubId &&
             userData.equipoId == equipoId;
    }
    
    // Colección de usuarios
    match /usuarios/{userId} {
      // Admins pueden leer todos los usuarios de su club
      // Usuarios pueden leer su propio documento
      allow read: if request.auth != null && 
                    (request.auth.uid == userId || 
                     get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'administrador_club');
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Los usuarios pueden actualizar su propio perfil EXCEPTO el rol y clubId
      // Solo el admin puede cambiar roles
      allow update: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.rol == resource.data.rol &&
                      request.resource.data.clubId == resource.data.clubId;
      
      // El admin puede actualizar cualquier usuario de su club (incluido cambiar roles)
      allow update: if request.auth != null &&
                      get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'administrador_club' &&
                      get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.clubId == resource.data.clubId;
      
      allow delete: if false; // Los usuarios no pueden eliminarse a sí mismos
    }
    
    // Colección de invitaciones (a nivel raíz, NO dentro de clubes)
    match /invitaciones/{invitacionId} {
      // Permitir lectura pública para que usuarios sin autenticar puedan ver su invitación
      allow read: if true;
      
      // Solo usuarios autenticados pueden crear invitaciones (administradores)
      allow create: if request.auth != null;
      
      // Permitir actualización para marcar como aceptada
      allow update: if true;
      
      // Solo el creador puede eliminar
      allow delete: if request.auth != null;
    }
    
    // Colección de clubes
    match /clubes/{clubId} {
      // Cualquier miembro del club puede leer los datos del club
      allow read: if isClubMember(clubId);
      
      // Solo el administrador puede crear, actualizar o eliminar el club
      allow create: if request.auth != null;
      allow update: if isAdmin(clubId);
      allow delete: if isAdmin(clubId);
      
      // Subcolección: Equipos del club
      match /equipos/{equipoId} {
        // Todos los miembros del club pueden leer la lista de equipos
        // (necesario para mostrar en dashboard y selects)
        allow read: if isClubMember(clubId);
        
        // Solo administradores pueden crear y eliminar equipos
        allow create, delete: if isAdmin(clubId);
        
        // Administradores pueden editar todos los equipos
        // Entrenadores solo pueden editar su equipo asignado
        allow update: if isAdmin(clubId) || isTeamCoach(clubId, equipoId);
        
        // Subcolección: Jugadores del equipo
        match /jugadores/{jugadorId} {
          // Todos los miembros pueden ver jugadores
          // (necesario para estadísticas y dashboard)
          allow read: if isClubMember(clubId);
          
          // Solo admin y entrenador del equipo pueden gestionar jugadores
          allow create, update, delete: if canManageTeam(clubId, equipoId);
        }
      }
      
      // Subcolección: Eventos del club
      match /eventos/{eventoId} {
        // Admin puede ver todos los eventos
        // Otros usuarios pueden ver eventos de su equipo (verificamos en el documento)
        allow read: if isAdmin(clubId) || isClubMember(clubId);
        
        // Solo admin y entrenadores pueden crear eventos
        allow create: if isAdmin(clubId) || 
                        (request.auth != null && 
                         get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'entrenador');
        
        // Solo admin puede editar/eliminar todos los eventos
        // Entrenadores solo pueden editar/eliminar eventos de su equipo
        allow update, delete: if isAdmin(clubId) || 
              (request.auth != null && 
               get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'entrenador');
        
        // Subcolección: Acciones del evento (goles, asistencias, tarjetas, etc.)
        match /acciones/{accionId} {
          // Todos los miembros del club pueden leer acciones
          allow read: if isClubMember(clubId);
          
          // Admin y entrenadores pueden crear/editar/eliminar acciones
          allow create, update, delete: if isAdmin(clubId) || 
                                          (request.auth != null && 
                                           get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'entrenador');
        }
        
        // Subcolección: Evaluaciones de jugadores del evento
        match /evaluaciones/{jugadorId} {
          // Todos los miembros del club pueden leer evaluaciones
          allow read: if isClubMember(clubId);
          
          // Admin y entrenadores pueden crear/editar/eliminar evaluaciones
          allow create, update, delete: if isAdmin(clubId) || 
                                          (request.auth != null && 
                                           get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'entrenador');
        }
      }
      
      // Subcolección: Categorías del club
      match /categorias/{categoriaId} {
        allow read: if isClubMember(clubId);
        allow create, update, delete: if isAdmin(clubId);
      }
      
      // Subcolección: Configuración del club
      match /configuracion/{configId} {
        allow read: if isClubMember(clubId);
        allow write: if isAdmin(clubId);
      }
    }
  }
}
